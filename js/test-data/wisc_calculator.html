<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora WISC-IV</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f4f7fa; color: #333; }
        .container { max-width: 1000px; margin: 20px auto; padding: 20px; background-color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 8px; }
        h2 { color: #005a9c; border-bottom: 2px solid #e1e1e1; padding-bottom: 10px; margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; font-weight: 600; }
        tr:last-child td { border-bottom: none; }
        .subtest-name { font-weight: 500; }
        input[type="number"], input[type="date"] { width: 90%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        input[type="text"]:read-only { background-color: #e9ecef; border-color: #ced4da; cursor: default; }
        .age-section { display: flex; gap: 20px; margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 5px; }
        .age-section div { flex: 1; }
        .button-container { text-align: right; margin-top: 30px; }
        button { padding: 12px 25px; background-color: #28a745; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #218838; }
        .results-header { font-size: 10px; color: #666; text-align: center; }
        #age-result { font-weight: bold; color: #005a9c; margin-top: 10px; height: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>WISC-IV: Avaliação de Inteligência para Crianças</h1>

        <div class="age-section">
            <div>
                <label for="birthDate">Data de Nascimento:</label>
                <input type="date" id="birthDate">
            </div>
            <div>
                <label for="testDate">Data da Avaliação:</label>
                <input type="date" id="testDate">
            </div>
            <div id="age-result"></div>
        </div>
        
        <!-- SEÇÃO DE SCORES COMPOSTOS (SAÍDA) -->
        <h2>Conversão da Soma dos Pontos Ponderados em Pontos Composto</h2>
        <table>
            <thead>
                <tr>
                    <th>Escala</th>
                    <th>Somatória Pontos Ponderados</th>
                    <th>Pontos Composto</th>
                    <th>Rank Percentil</th>
                    <th colspan="2">Intervalo de Confiança</th>
                    <th>Classificação</th>
                </tr>
                <tr>
                    <td></td><td></td><td></td><td></td>
                    <td class="results-header">90%</td>
                    <td class="results-header">95%</td>
                    <td></td>
                </tr>
            </thead>
            <tbody>
                <!-- Compreensão Verbal -->
                <tr>
                    <td class="subtest-name">Compreensão Verbal</td>
                    <td><input type="text" id="sum_icv" readonly></td>
                    <td><input type="text" id="comp_icv" readonly></td>
                    <td><input type="text" id="perc_icv" readonly></td>
                    <td><input type="text" id="ci90_icv" readonly></td>
                    <td><input type="text" id="ci95_icv" readonly></td>
                    <td><input type="text" id="class_icv" readonly></td>
                </tr>
                <!-- Organização Perceptual -->
                <tr>
                    <td class="subtest-name">Organização Perceptual</td>
                    <td><input type="text" id="sum_iop" readonly></td>
                    <td><input type="text" id="comp_iop" readonly></td>
                    <td><input type="text" id="perc_iop" readonly></td>
                    <td><input type="text" id="ci90_iop" readonly></td>
                    <td><input type="text" id="ci95_iop" readonly></td>
                    <td><input type="text" id="class_iop" readonly></td>
                </tr>
                <!-- Memória Operacional -->
                <tr>
                    <td class="subtest-name">Memória Operacional</td>
                    <td><input type="text" id="sum_imo" readonly></td>
                    <td><input type="text" id="comp_imo" readonly></td>
                    <td><input type="text" id="perc_imo" readonly></td>
                    <td><input type="text" id="ci90_imo" readonly></td>
                    <td><input type="text" id="ci95_imo" readonly></td>
                    <td><input type="text" id="class_imo" readonly></td>
                </tr>
                <!-- Velocidade de Processamento -->
                <tr>
                    <td class="subtest-name">Velocidade de Processamento</td>
                    <td><input type="text" id="sum_ivp" readonly></td>
                    <td><input type="text" id="comp_ivp" readonly></td>
                    <td><input type="text" id="perc_ivp" readonly></td>
                    <td><input type="text" id="ci90_ivp" readonly></td>
                    <td><input type="text" id="ci95_ivp" readonly></td>
                    <td><input type="text" id="class_ivp" readonly></td>
                </tr>
                <!-- QI Total -->
                <tr>
                    <td class="subtest-name">QI Total</td>
                    <td><input type="text" id="sum_qit" readonly></td>
                    <td><input type="text" id="comp_qit" readonly></td>
                    <td><input type="text" id="perc_qit" readonly></td>
                    <td><input type="text" id="ci90_qit" readonly></td>
                    <td><input type="text" id="ci95_qit" readonly></td>
                    <td><input type="text" id="class_qit" readonly></td>
                </tr>
            </tbody>
        </table>

        <!-- SEÇÃO DE PONTOS BRUTOS (ENTRADA) -->
        <h2>Conversão Pontos Brutos em Ponderados</h2>
        <table>
            <thead>
                <tr>
                    <th>Sub-Teste</th>
                    <th>Pontos Brutos</th>
                    <th>Pontos Ponderados</th>
                    <th>Classificação</th>
                </tr>
            </thead>
            <tbody>
                <tr><td class="subtest-name">Cubos (CB)</td><td><input type="number" id="raw_cubos" value="5"></td><td><input type="text" id="w_cubos" readonly></td><td><input type="text" id="c_cubos" readonly></td></tr>
                <tr><td class="subtest-name">Semelhanças (SM)</td><td><input type="number" id="raw_semelhancas" value="2"></td><td><input type="text" id="w_semelhancas" readonly></td><td><input type="text" id="c_semelhancas" readonly></td></tr>
                <tr><td class="subtest-name">Dígitos (DG)</td><td><input type="number" id="raw_digitos" value="5"></td><td><input type="text" id="w_digitos" readonly></td><td><input type="text" id="c_digitos" readonly></td></tr>
                <tr><td class="subtest-name">Conceitos Figurativos (CN)</td><td><input type="number" id="raw_conceitosFigurativos" value="2"></td><td><input type="text" id="w_conceitosFigurativos" readonly></td><td><input type="text" id="c_conceitosFigurativos" readonly></td></tr>
                <tr><td class="subtest-name">Código (CD)</td><td><input type="number" id="raw_codigo" value="5"></td><td><input type="text" id="w_codigo" readonly></td><td><input type="text" id="c_codigo" readonly></td></tr>
                <tr><td class="subtest-name">Vocabulário (VC)</td><td><input type="number" id="raw_vocabulario" value="5"></td><td><input type="text" id="w_vocabulario" readonly></td><td><input type="text" id="c_vocabulario" readonly></td></tr>
                <tr><td class="subtest-name">Seq. Núm. & Letras (SNL)</td><td><input type="number" id="raw_sequenciaNumerosLetras" value="5"></td><td><input type="text" id="w_sequenciaNumerosLetras" readonly></td><td><input type="text" id="c_sequenciaNumerosLetras" readonly></td></tr>
                <tr><td class="subtest-name">Raciocínio Matricial (RM)</td><td><input type="number" id="raw_raciocinioMatricial" value="5"></td><td><input type="text" id="w_raciocinioMatricial" readonly></td><td><input type="text" id="c_raciocinioMatricial" readonly></td></tr>
                <tr><td class="subtest-name">Compreensão (CO)</td><td><input type="number" id="raw_compreensao" value="2"></td><td><input type="text" id="w_compreensao" readonly></td><td><input type="text" id="c_compreensao" readonly></td></tr>
                <tr><td class="subtest-name">Procurar Símbolos (PS)</td><td><input type="number" id="raw_procurarSimbolos" value="2"></td><td><input type="text" id="w_procurarSimbolos" readonly></td><td><input type="text" id="c_procurarSimbolos" readonly></td></tr>
                <tr><td class="subtest-name">(Completar Figuras) (CF)</td><td><input type="number" id="raw_completarFiguras" value="2"></td><td><input type="text" id="w_completarFiguras" readonly></td><td><input type="text" id="c_completarFiguras" readonly></td></tr>
                <tr><td class="subtest-name">(Cancelamento) (CA)</td><td><input type="number" id="raw_cancelamento" value="5"></td><td><input type="text" id="w_cancelamento" readonly></td><td><input type="text" id="c_cancelamento" readonly></td></tr>
                <tr><td class="subtest-name">(Informação) (IN)</td><td><input type="number" id="raw_informacao" value="5"></td><td><input type="text" id="w_informacao" readonly></td><td><input type="text" id="c_informacao" readonly></td></tr>
                <tr><td class="subtest-name">(Aritmética) (AR)</td><td><input type="number" id="raw_aritmetica" value="5"></td><td><input type="text" id="w_aritmetica" readonly></td><td><input type="text" id="c_aritmetica" readonly></td></tr>
                <tr><td class="subtest-name">(Raciocínio Palavras) (RP)</td><td><input type="number" id="raw_raciocinioPalavras" value="1"></td><td><input type="text" id="w_raciocinioPalavras" readonly></td><td><input type="text" id="c_raciocinioPalavras" readonly></td></tr>
            </tbody>
        </table>

        <div class="button-container">
            <button id="calculateBtn">Calcular Resultados</button>
        </div>
    </div>

    <!-- SCRIPT DE DADOS (DEVE ESTAR NA MESMA PASTA) -->
    <script src="wisc-iv-data.js"></script>

    <!-- LÓGICA DO FORMULÁRIO -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Preenche a data de hoje como padrão
            document.getElementById('testDate').valueAsDate = new Date();

            const calculateBtn = document.getElementById('calculateBtn');
            calculateBtn.addEventListener('click', runAllCalculations);
        });

        function calculateAge(birthDate, testDate) {
            if (!birthDate || !testDate) return null;

            let years = testDate.getFullYear() - birthDate.getFullYear();
            let months = testDate.getMonth() - birthDate.getMonth();
            let days = testDate.getDate() - birthDate.getDate();

            if (days < 0) {
                months--;
                days += new Date(testDate.getFullYear(), testDate.getMonth(), 0).getDate();
            }
            if (months < 0) {
                years--;
                months += 12;
            }
            return { years, months, days };
        }

        function runAllCalculations() {
            const birthDate = document.getElementById('birthDate').valueAsDate;
            const testDate = document.getElementById('testDate').valueAsDate;

            if (!birthDate) {
                alert("Por favor, insira a Data de Nascimento.");
                return;
            }

            const age = calculateAge(birthDate, testDate);
            document.getElementById('age-result').textContent = `Idade: ${age.years} anos, ${age.months} meses, ${age.days} dias`;
            
            const wiscApi = FSLaudosApp.testData.WiscIV;
            const subtestResults = {};

            const subtests = [
                'cubos', 'semelhancas', 'digitos', 'conceitosFigurativos', 'codigo', 'vocabulario',
                'sequenciaNumerosLetras', 'raciocinioMatricial', 'compreensao', 'procurarSimbolos',
                'completarFiguras', 'cancelamento', 'informacao', 'aritmetica', 'raciocinioPalavras'
            ];

            // 1. Calcular Pontos Ponderados para cada subteste
            subtests.forEach(id => {
                const rawScore = document.getElementById(`raw_${id}`).value;
                const result = wiscApi.getWeightedScore(id, rawScore, age);
                
                document.getElementById(`w_${id}`).value = result.weighted;
                document.getElementById(`c_${id}`).value = result.classification;
                
                // Armazena o ponto ponderado como número para somar depois
                subtestResults[id] = {
                    weighted: parseInt(result.weighted || 0, 10)
                };
            });

            // 2. Calcular Somatórias e Pontos Compostos
            calculateCompositeScores(subtestResults, wiscApi);
        }

        function calculateCompositeScores(results, wiscApi) {
            // Define os subtestes principais para cada índice e para o QIT
            const icv_subtests = ['semelhancas', 'vocabulario', 'compreensao'];
            const iop_subtests = ['cubos', 'conceitosFigurativos', 'raciocinioMatricial'];
            const imo_subtests = ['digitos', 'sequenciaNumerosLetras'];
            const ivp_subtests = ['codigo', 'procurarSimbolos'];
            const qit_subtests = [...icv_subtests, ...iop_subtests, ...imo_subtests, ...ivp_subtests];

            const indices = {
                icv: { scale: 'compreensaoVerbal', subtests: icv_subtests },
                iop: { scale: 'organizacaoPerceptual', subtests: iop_subtests },
                imo: { scale: 'memoriaOperacional', subtests: imo_subtests },
                ivp: { scale: 'velocidadeProcessamento', subtests: ivp_subtests },
                qit: { scale: 'qiTotal', subtests: qit_subtests }
            };

            for (const key in indices) {
                const index = indices[key];
                
                // Calcula a somatória dos pontos ponderados
                const sum = index.subtests.reduce((acc, subtestId) => acc + results[subtestId].weighted, 0);
                
                // Obtém o resultado composto
                const compositeResult = wiscApi.getCompositeScore(index.scale, sum);

                // Atualiza os campos no formulário
                document.getElementById(`sum_${key}`).value = sum > 0 ? sum : '';
                document.getElementById(`comp_${key}`).value = compositeResult.composite;
                document.getElementById(`perc_${key}`).value = compositeResult.percentile;
                document.getElementById(`ci90_${key}`).value = compositeResult.ci_90;
                document.getElementById(`ci95_${key}`).value = compositeResult.ci_95;
                document.getElementById(`class_${key}`).value = compositeResult.classification;
            }
        }
    </script>
</body>
</html>